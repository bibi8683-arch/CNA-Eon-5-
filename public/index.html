<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
// --- CONTRÔLE DE L'AGENT ÉON 5.1 ---

// Éléments DOM principaux
const videoElement = document.getElementById('video-stream');
const authSection = document.getElementById('auth-section');
const chatWindow = document.getElementById('chat-window');
const chatInputArea = document.getElementById('chat-input-area');
const statusDiv = document.getElementById('status');
const keyInput = document.getElementById('secret-key');
const verifyButton = document.getElementById('verify-button');
const sendButton = document.getElementById('send-button');
const messageInput = document.getElementById('message-input');
const correctKey = 'Bibi8683'; // Clé secrète (à remplacer par la biométrie plus tard)

let faceDetectionInterval; // Intervalle pour la boucle de détection

// Fonction utilitaire pour ajouter des messages au chat
function appendMessage(sender, text) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender === 'eon' ? 'eon-msg' : 'user-msg');
    msgDiv.innerHTML = '<strong>' + sender.toUpperCase() + ' :</strong> ' + text.replace('Agent Éon 5.0', 'Agent Éon 5.1');
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Fonction pour gérer l'envoi de messages au serveur (/api/chat)
async function sendMessage() {
    const text = messageInput.value.trim();
    if (text === '') return;

    appendMessage('user', text);
    messageInput.value = '';

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: text,
                key: correctKey // Envoie la clé pour l'authentification côté serveur
            })
        });

        if (response.ok) {
            const data = await response.json();
            appendMessage('eon', data.response);
        } else {
            appendMessage('eon', "ERREUR: Échec de la communication avec le Noyau CNA (Statut non OK).");
        }
    } catch (error) {
        console.error('Erreur lors de la conversation:', error);
        appendMessage('eon', "ERREUR: Impossible de contacter le serveur CNA. Vérifiez votre connexion.");
    }
}


// Fonction pour démarrer la détection faciale (Biométrie)
async function startFaceDetection(statusDiv) {
    statusDiv.textContent = 'Statut: Chargement des modèles IA...';

    try {
        // 1. Chargement des modèles depuis le dossier 'public/models'
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('/models')
        ]);

        statusDiv.textContent = 'Statut: Modèles chargés. Démarrage de la vidéo...';

        // 2. Initialisation de la caméra
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = stream;
        videoElement.style.display = 'block';

        videoElement.addEventListener('play', () => {
            statusDiv.textContent = 'Détection active. Orientez votre visage vers la caméra.';
            statusDiv.style.backgroundColor = '#58a6ff'; 

            // Création d'un canvas pour dessiner les boîtes
            const canvas = faceapi.createCanvasFromMedia(videoElement);
            videoElement.parentNode.insertBefore(canvas, videoElement.nextSibling);

            const displaySize = { width: videoElement.offsetWidth, height: videoElement.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // 3. Boucle de détection
            faceDetectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                faceapi.draw.drawDetections(canvas, resizedDetections);
                
                if (resizedDetections.length > 0) {
                    // Si un visage est détecté
                    statusDiv.textContent = "✅ VISAGE DÉTECTÉ! Authentification en cours...";
                    // PLUS TARD : Ici, vous auriez la logique de vérification d'identité
                } else {
                    statusDiv.textContent = "❌ Pas de visage détecté. Veuillez vous centrer.";
                }
            }, 100); 
        });

    } catch (err) {
        // Erreur si l'accès à la caméra est refusé ou si les modèles ne sont pas trouvés
        statusDiv.textContent = '❌ Échec Biométrie: Accès refusé ou modèles IA manquants (public/models).';
        statusDiv.style.backgroundColor = '#8B0000';
        console.error("Erreur de détection faciale : ", err);
    }
}


// Fonction principale appelée par l'Event Listener du bouton de vérification
function initBiometricScan(statusDiv) {
    if (faceDetectionInterval) clearInterval(faceDetectionInterval);
    startFaceDetection(statusDiv);
}


// --- DÉMARRAGE DE L'APPLICATION ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. AJOUT DE L'ÉLÉMENT VIDÉO DANS L'HTML
    // (Ajouté ici car il doit exister avant les scripts)
    // NOTE : L'élément <video id='video-stream' autoplay playsinline></video>
    // doit être présent dans le corps HTML pour que ce script fonctionne.
    // Il est placé dans la section auth-section dans le code HTML complet.

    // 2. Event Listeners
    verifyButton.addEventListener('click', () => {
        if (keyInput.value === correctKey) {
            statusDiv.style.backgroundColor = '#006400';
            statusDiv.textContent = '✅ ACCÈS CNA ACCORDÉ. Bienvenue Vi scene thé !';
            
            // Lancement de la détection faciale
            initBiometricScan(statusDiv); 
            
            setTimeout(() => {
                // Masque l'authentification et passe au chat
                authSection.style.display = 'none'; 
                chatWindow.style.display = 'flex';
                chatInputArea.style.display = 'flex';
                appendMessage('eon', 'Agent Éon 5.1 en ligne. Le chat est actif et son cerveau est connecté. Quel est le premier objectif que vous me donnez ici ?');
            }, 1500);
        } else {
            statusDiv.style.backgroundColor = '#8B0000';
            statusDiv.textContent = 'Statut: Clé Invalide. Accès Refusé.';
        }
    });
    
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
});
</script>
